services:
  aix-db:
    image: crpi-7xkxsdc0iki61l0q.cn-hangzhou.personal.cr.aliyuncs.com/apconw/aix-db:1.2.2
    container_name: aix-db
    restart: unless-stopped
    environment:
      # 时区
      TZ: Asia/Shanghai

      # 后端服务配置
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: ${SERVER_PORT:-8088}
      SERVER_WORKERS: ${SERVER_WORKERS:-2}

      # Langfuse 配置（可选）
      LANGFUSE_TRACING_ENABLED: ${LANGFUSE_TRACING_ENABLED:-false}
      LANGFUSE_SECRET_KEY: ${LANGFUSE_SECRET_KEY:-}
      LANGFUSE_PUBLIC_KEY: ${LANGFUSE_PUBLIC_KEY:-}
      LANGFUSE_BASE_URL: ${LANGFUSE_BASE_URL:-}

    ports:
      # 前端（通过 nginx）
      - "18080:80"
      # 后端 API
      - "18088:8088"
      # PostgreSQL
      - "15432:5432"
      # MinIO API
      - "19000:9000"
      # MinIO Console
      - "19001:9001"

    volumes:
      # PostgreSQL 数据目录
      - ./volume/pg_data:/var/lib/postgresql/data
      # PostgreSQL 初始化脚本（首次启动时自动执行）
      - ./init_sql.sql:/docker-entrypoint-initdb.d/init.sql:ro
      # MinIO 数据目录
      - ./volume/minio/data:/data
      # 日志目录（可选）
      - ./volume/logs/supervisor:/var/log/supervisor
      - ./volume/logs/nginx:/var/log/nginx
      - ./volume/logs/aix-db:/var/log/aix-db
      - ./volume/logs/minio:/var/log/minio
      - ./volume/logs/postgresql:/var/log/postgresql

    extra_hosts:
      - "host.docker.internal:host-gateway"

    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost/ && pg_isready -U aix_db -h localhost" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
